from converter import CommandResultConverter
from command_executor import GobusterCommandExecutor, NmapCommandExecutor, RustScanCommandExecutor
from bottle import Bottle, template, request, static_file
import requests
import pathlib

###########################################################
##
## MAIN APPLICATION DEFINITION
## 
###########################################################
app = Bottle()

@app.hook('before_request')
def log_request():
    log_string = ""

    log_string += f"url = {request.url} \n"
    for index, key in enumerate (list(request.params.keys())):
        log_string += f"{key} = {request.params[key]} \n"

    print(log_string)



# @app.route("/client/get-information-gathering-urls")
# def get_information_gathering_urls():
    
#     app_urls = []

#     # print(information_gathering_app.routes[0].rule)

#     for index in range(len(app.routes)):
#         url = app.routes[index].rule
#         app_urls.append(url)

#     return {"list": app_urls}


###########################################################
##
## APIS FOR CLIENTS
## 
###########################################################
@app.route("/")
def start():
    download_enum_scripts_from_official_repos()
    return template("index.html", output=get_app_urls())




### resources

@app.route('/resources/enum-scripts/<filename:path>')
def download(filename):
    return static_file(filename.lower(), root='resources/enum-scripts', download=True)



###########################################################
##
## APIS FOR CLIENTS
## 
###########################################################
@app.route("/client/get-all-api-endpoint-urls")
def start():
    return get_app_urls()






###########################################################
##
## INFORMATION GATHERING
## 
###########################################################

### network/scanner/nmap/

@app.route('/information-gathering/network/scanner/nmap/version')
def network_scanner_nmap_version():
    nmap_cmd = NmapCommandExecutor(request.query.ip, request.query.ports)
    command_result = nmap_cmd.services_version_scan()
    return CommandResultConverter.to_html(command_result)

@app.route('/information-gathering/network/scanner/nmap/aggressive')
def network_scanner_nmap_aggressive():
    nmap_cmd = NmapCommandExecutor(request.query.ip, request.query.ports)
    command_result = nmap_cmd.aggressive_scan()
    return CommandResultConverter.to_html(command_result)




### network/scanner/rustscan

@app.route('/information-gathering/network/scanner/rustscan/scan')
def network_scanner_rustscan():
    rustscan_cmd = RustScanCommandExecutor(request.query.ip, request.query.ports, request.query.range)
    command_result = rustscan_cmd.scan()
    return CommandResultConverter.to_html(command_result)




### webapp/scanner/gobuster

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-big-dirb-dictionary')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address, request.query.port)
    command_result = gobuster_cmd.enumerate_url_big_dirb_dictionary()
    return CommandResultConverter.to_html(command_result)

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-big-dirb-dictionary-common-extensions')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address, request.query.port)
    command_result = gobuster_cmd.enumerate_url_big_dirb_dictionary_common_extensions()
    return CommandResultConverter.to_html(command_result)

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-small-dirbuster-dictionary')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address, request.query.port)
    command_result = gobuster_cmd.enumerate_url_small_dirbuster_dictionary()
    return CommandResultConverter.to_html(command_result)

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-small-dirbuster-dictionary-common-extension')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address, request.query.port)
    command_result = gobuster_cmd.enumerate_url_small_dirbuster_dictionary_common_extensions()
    return CommandResultConverter.to_html(command_result)




###########################################################
## 
## APP FUNCTIONS
## 
###########################################################
def get_app_urls():
    app_urls = []

    for index in range(len(app.routes)):
        app_urls.append(app.routes[index].rule)     

    return_object = { "data": app_urls}
    return return_object

def download_enum_scripts_from_official_repos():
    pathlib.Path('resources/enum-scripts').mkdir(parents=True, exist_ok=True)
    with open('resources/enum-scripts/linpeas.sh', 'w') as f:
        f.write(requests.get("https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/linPEAS/linpeas.sh", allow_redirects=True).text)
    with open('resources/enum-scripts/linenum.sh', 'w') as f:
        f.write(requests.get("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", allow_redirects=True).text)
    with open('resources/enum-scripts/winpeas.bat', 'w') as f:
        f.write(requests.get("https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/winPEAS/winPEASbat/winPEAS.bat", allow_redirects=True).text)


###########################################################
## 
## MAIN
## 
###########################################################
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=6660, debug=True, reloader=True)

# app = default_app()