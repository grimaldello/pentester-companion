from converter import CommandResultConverter
from command_executor import GobusterCommandExecutor, NmapCommandExecutor, RustScanCommandExecutor
from bottle import Bottle, template, request, response, static_file, redirect
import requests
import pathlib
import uuid 
from app_settings import get_command_output_path, get_resource_enum_scripts_path, get_command_output_redirect_url
from app_settings import LINENUM_REPOSITORY_URL, LINPEAS_REPOSITORY_URL, WINPEAS_REPOSITORY_URL

###########################################################
##
## MAIN APPLICATION DEFINITION
## 
###########################################################
app = Bottle()


### application hooks

@app.hook('before_request')
def log_request():
    
    log_string = ""

    log_string += f"url = {request.url} \n"
    for index, key in enumerate (list(request.params.keys())):
        log_string += f"{key} = {request.params[key]} \n"

    print(log_string)


###########################################################
##
## APIS FOR CLIENTS
## 
###########################################################
@app.route("/")
def start():
    download_enum_scripts_from_official_repos()
    return template("index.html", output=get_app_urls())

@app.route("/get-command-output")
def get_command_output():
    output_file_text_content = pathlib.Path(get_command_output_path(request.query.request_id)).read_text()
    return CommandResultConverter.to_html(output_file_text_content)


### resources

@app.route('/download-script/<filename:path>')
def download(filename):
    return static_file(filename.lower(), root=get_resource_enum_scripts_path(), download=True)




###########################################################
##
## APIS FOR CLIENTS
## 
###########################################################
@app.route("/client/get-all-api-endpoint-urls")
def start():
    return get_app_urls()






###########################################################
##
## INFORMATION GATHERING
## 
###########################################################

### network/scanner/nmap/

@app.route('/information-gathering/network/scanner/nmap/version')
def network_scanner_nmap_version():
    nmap_cmd = NmapCommandExecutor(request.query.ip, request.query.ports)
    request_id = nmap_cmd.services_version_scan()
    redirect(get_command_output_redirect_url(request_id))

@app.route('/information-gathering/network/scanner/nmap/aggressive')
def network_scanner_nmap_aggressive():
    nmap_cmd = NmapCommandExecutor(request.query.ip, request.query.ports)
    request_id = nmap_cmd.aggressive_scan()
    redirect(get_command_output_redirect_url(request_id))





### network/scanner/rustscan

@app.route('/information-gathering/network/scanner/rustscan/scan')
def network_scanner_rustscan_scan():
    rustscan_cmd = RustScanCommandExecutor(request.query.ip, request.query.ports, request.query.range)
    request_id = rustscan_cmd.scan()
    redirect(get_command_output_redirect_url(request_id))





### webapp/scanner/gobuster

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-big-dirb-dictionary')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address, request.query.port)
    request_id = gobuster_cmd.enumerate_url_big_dirb_dictionary()
    redirect(get_command_output_redirect_url(request_id))

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-big-dirb-dictionary-common-extensions')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address, request.query.port)
    request_id = gobuster_cmd.enumerate_url_big_dirb_dictionary_common_extensions()
    redirect(get_command_output_redirect_url(request_id))

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-small-dirbuster-dictionary')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address, request.query.port)
    request_id = gobuster_cmd.enumerate_url_small_dirbuster_dictionary()
    redirect(get_command_output_redirect_url(request_id))

@app.route('/information-gathering/webapp/scanner/gobuster/enumerate-url-small-dirbuster-dictionary-common-extension')
def network_scanner_rustscan():
    gobuster_cmd = GobusterCommandExecutor(request.query.address, request.query.port)
    request_id = gobuster_cmd.enumerate_url_small_dirbuster_dictionary_common_extensions()
    redirect(get_command_output_redirect_url(request_id))




###########################################################
## 
## APP FUNCTIONS
## 
###########################################################
def get_app_urls():
    app_urls = []

    for index in range(len(app.routes)):
        app_urls.append(app.routes[index].rule)     

    return_object = { "data": app_urls}
    return return_object

def download_enum_scripts_from_official_repos():
    with open(get_resource_enum_scripts_path('linpeas.sh'), 'w') as f:
        f.write(requests.get(LINPEAS_REPOSITORY_URL, allow_redirects=True).text)
    with open(get_resource_enum_scripts_path('linenum.sh'), 'w') as f:
        f.write(requests.get(LINENUM_REPOSITORY_URL, allow_redirects=True).text)
    with open(get_resource_enum_scripts_path('winpeas.bat'), 'w') as f:
        f.write(requests.get(WINPEAS_REPOSITORY_URL, allow_redirects=True).text)


###########################################################
## 
## MAIN
## 
###########################################################
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=6660, debug=True, reloader=True)

# app = default_app()