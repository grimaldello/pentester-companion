import subprocess
import uuid
from app_settings import get_command_output_path
from app_settings import DIRB_BIG, DIRBUSTER_SMALL



class BaseCommandExecutor:
    def __init__(self) -> None:
        self.request_id = str(uuid.uuid4())
        print(self.request_id)

    def _formatted_output_string_command(self, command_to_execute):
        output =  "#####################################################################\n"
        output += "#\n"
        output += f"# {command_to_execute} \n"
        output += "#\n"
        output += "#####################################################################\n"
        output += "\n"
        return output

    def execute_command(self, command_parameter_as_list):
        command_to_execute = subprocess.list2cmdline(command_parameter_as_list)
        print(self._formatted_output_string_command(command_to_execute))
        command_result = subprocess.run(command_parameter_as_list, stdout=subprocess.PIPE, stderr=subprocess.PIPE).stdout.decode('utf-8')
        return command_result

    def execute_command_background(self, command_parameter_as_list):
        command_to_execute = subprocess.list2cmdline(command_parameter_as_list)
        print(self._formatted_output_string_command(command_to_execute))
        with open(get_command_output_path(self.request_id ), "w") as output_file:
            output_file.write(self._formatted_output_string_command(command_to_execute))
            subprocess.Popen(command_parameter_as_list, stdout=output_file, stderr=output_file) # This will run in the background
        return self.request_id




class NmapCommandExecutor(BaseCommandExecutor):
    def __init__(self, ip, ports) -> None:
        super().__init__()
        self.ip = ip
        self.ports = ports
        if ports == None or ports == "":
            print("No ports specified. Will be used 1-65535 as port range")
            self.ports = "1-65535" 

    def _get_base_cmd(self):
        return ["nmap", "-T", "4", "-v", "-Pn"]

    def services_version_scan(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["-sC", "-sV", f"{self.ip}", "-p", f"{self.ports}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id

    def aggressive_scan(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["-A", f"{self.ip}", "-p", f"{self.ports}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id




class RustScanCommandExecutor(BaseCommandExecutor):
    def __init__(self, ip, ports, range) -> None:
        super().__init__()
        self.ip = ip
        self.ports = ports
        self.ports_range = range
        if ports == None or ports == "":
            print("No ports specified. Will be used 1-65535 as ports range")
            self.ports_range = "1-65535"

    def _get_base_cmd(self):
        return ["rustscan", "--ulimit", "5000", "-t", "2000"]

    def scan(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["-a", f"{self.ip}"])
        if self.ports != None and self.ports != "":
            cmd_to_execute.extend(["-p", f"{self.ports}"])
        elif self.ports_range != None and self.ports_range != "":
            cmd_to_execute.extend(["-r", f"{self.ports_range}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id




class GobusterCommandExecutor(BaseCommandExecutor):
    def __init__(self, address) -> None:
        super().__init__()
        self.address = address
        # TO-DO add check on address
        self.full_url = self.address

    def _get_base_cmd(self):
        return ["gobuster"]

    def enumerate_url_big_dirb_dictionary(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["dir"])
        cmd_to_execute.extend(["-w", DIRB_BIG])
        cmd_to_execute.extend(["-u", f"{self.full_url}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id

    def enumerate_url_big_dirb_dictionary_common_extensions(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["dir"])
        cmd_to_execute.extend(["-w", DIRB_BIG])
        cmd_to_execute.extend(["-u", f"{self.full_url}"])
        cmd_to_execute.extend(["-x", "html,php,txt"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id

    def enumerate_url_small_dirbuster_dictionary(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["dir"])
        cmd_to_execute.extend(["-w", DIRBUSTER_SMALL])
        cmd_to_execute.extend(["-u", f"{self.full_url}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id

    def enumerate_url_small_dirbuster_dictionary_common_extensions(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["dir"])
        cmd_to_execute.extend(["-w", DIRBUSTER_SMALL])
        cmd_to_execute.extend(["-u", f"{self.full_url}"])
        cmd_to_execute.extend(["-x", "html,php,txt"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id