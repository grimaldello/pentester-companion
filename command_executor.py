import subprocess
import uuid
from app_settings import get_command_output_path




class BaseCommandExecutor:
    def __init__(self) -> None:
        self.request_id = str(uuid.uuid4())
        print(self.request_id)

    def execute_command(self, command_parameter_as_list):
        print(f"Command to execute: {subprocess.list2cmdline(command_parameter_as_list)}")
        command_result = subprocess.run(command_parameter_as_list, stdout=subprocess.PIPE, stderr=subprocess.PIPE).stdout.decode('utf-8')
        return command_result

    def execute_command_background(self, command_parameter_as_list):
        print(f"Command to execute: {subprocess.list2cmdline(command_parameter_as_list)}")
        with open(get_command_output_path(self.request_id ), "w") as output_file:
            subprocess.Popen(command_parameter_as_list, stdout=output_file, stderr=output_file) # This will run in the background
        return self.request_id





class NmapCommandExecutor(BaseCommandExecutor):
    def __init__(self, ip, ports) -> None:
        super().__init__()
        self.ip = str(ip).strip()
        self.ports = str(ports).strip()
        if ports == None or ports == "":
            print("No ports specified. Will be used 1-65535 as port range")
            self.ports = "1-65535" 

    def _get_base_cmd(self):
        return ["nmap", "-T", "4", "-v", "-Pn"]

    def services_version_scan(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["-sC", "-sV", f"{self.ip}", "-p", f"{self.ports}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id

    def aggressive_scan(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["-A", f"{self.ip}", "-p", f"{self.ports}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id




class RustScanCommandExecutor(BaseCommandExecutor):
    def __init__(self, ip, ports, range) -> None:
        super().__init__()
        self.ip = str(ip).strip()
        self.ports = str(ports).strip()
        self.ports_range = str(range).strip()
        if ports == None or ports == "":
            print("No ports specified. Will be used 1-65535 as ports range")
            self.ports_range = "1-65535"

    def _get_base_cmd(self):
        return ["rustscan", "--ulimit", "5000", "-t", "2000"]

    def scan(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["-a", f"{self.ip}"])
        if self.ports != None and self.ports != "":
            cmd_to_execute.extend(["-p", f"{self.ports}"])
        elif self.ports_range != None and self.ports_range != "":
            cmd_to_execute.extend(["-r", f"{self.ports_range}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id




class GobusterCommandExecutor(BaseCommandExecutor):
    def __init__(self, address, port) -> None:
        super().__init__()
        self.address = str(address).strip()
        self.port = str(port).strip()
        self.full_url = ""
        if "http://" not in self.address and "https://" not in self.address:
            print("No http scheme specified. Scheme http:// will be used as default")
            self.address = f"http://{self.address}"
        if self.port != None and self.port != "":
            self.full_url = f"{self.address}:{self.port}"
        else:
            if "http://" in self.address:
                print("No port specified. Port 80 will be used since scheme in http://")
                self.full_url = f"{self.address}:80"
            elif "https://" in self.address:
                print("No port specified. Port 443 will be used since scheme in https://")
                self.full_url = f"{self.address}:443"

    def _get_base_cmd(self):
        return ["gobuster"]

    def enumerate_url_big_dirb_dictionary(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["dir"])
        cmd_to_execute.extend(["-w", "/usr/share/wordlists/dirb/big.txt"])
        cmd_to_execute.extend(["-u", f"{self.full_url}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id

    def enumerate_url_big_dirb_dictionary_common_extensions(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["dir"])
        cmd_to_execute.extend(["-w", "/usr/share/wordlists/dirb/big.txt"])
        cmd_to_execute.extend(["-u", f"{self.full_url}"])
        cmd_to_execute.extend(["-x", "html,php,txt"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id

    def enumerate_url_small_dirbuster_dictionary(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["dir"])
        cmd_to_execute.extend(["-w", "/usr/share/wordlists/dirbuster/directory-list-2.3-small.txt"])
        cmd_to_execute.extend(["-u", f"{self.full_url}"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id

    def enumerate_url_small_dirbuster_dictionary_common_extensions(self):
        cmd_to_execute = self._get_base_cmd()
        cmd_to_execute.extend(["dir"])
        cmd_to_execute.extend(["-w", "/usr/share/wordlists/dirbuster/directory-list-2.3-small.txt"])
        cmd_to_execute.extend(["-u", f"{self.full_url}"])
        cmd_to_execute.extend(["-x", "html,php,txt"])
        command_result_request_id = self.execute_command_background(cmd_to_execute)
        return command_result_request_id